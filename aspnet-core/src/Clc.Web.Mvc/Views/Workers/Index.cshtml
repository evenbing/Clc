@using Clc.Fields
@{
    Layout = "~/Views/Shared/_CrudLayout.cshtml";
}

@section customScript
{
    <environment names="Development">
        <script src="~/js/finger.js" asp-append-version="true"></script>
    </environment>
    <environment names="Staging,Production">
        <script src="~/js/finger.min.js" asp-append-version="true"></script>
    </environment>

    <script type="text/javascript">
        crud.dgDefault.name = 'Workers';
        crud.dgDefault.sortName = 'cn';
        var title = abp.setting.get('VI.DepotTitleName');
        crud.dgDefault.columns = [[
            { field: "cn", title: "编号", width: 80, sortable: true },
            { field: "name", title: "名称", width: 80 },
            { field: "postId", title: "岗位", width: 100, formatter: postFormatter },
            { field: "password", title: "登录密码", width: 80 },
            { field: "workerRoleName", title: "登录角色名", width: 80, sortable: true },
            { field: "workRoles", title: "可担任角色列表", width: 80 },
            { field: "rfid", title: "RFID", width: 100 },         
            { field: "additiveInfo", title: "附加认证信息", width: 100 },
            { field: "deviceId", title: "微信设备号", width: 120 },
            { field: "fingerLength", title: "指一大小", width: 60 },
            { field: "finger2Length", title: "指二大小", width: 60 },
            // { field: "loanDepotId", title: "借用到", width: 60, loanDepotFormatter },
            { field: "photoLength", title: "照片大小", width: 60 },
            { field: "isActive", title: "启用", width: 60 }
        ]];
        crud.parentField = 'depotId';
        crud.children = true;

        // formatters
        function postFormatter(val) {
            return crud.getComboTextByInt('#post', val);
        }
        function loanDepotFormatter(val) {
            return crud.getComboTextByInt('#loadDepot', val);
        }

        // finger
        function getFinger(el) {
            alert('请把手指放到指纹仪上');
            var code = finger.regCode(fm.ZAZFingerActivex);
            //alert(code.length);

            $('#'+el).textbox('setValue', code);
        }
        function validFinger(el) {
            var dst = finger.getCode(fm.ZAZFingerActivex);
            var result = finger.match(fm.ZAZFingerActivex, $('#'+el).textbox('getValue'), dst);
            abp.notify.info("验证结果为:" + result);
        }

    </script>
}

@section endScript
{
    <script type="text/javascript">
        crud.startfunction = function () {
            abp.services.app.type.getComboItems('Post').done(function(d) {
                crud.setComboBox('#post', d);
            });

            abp.services.app.user.getRoles(true).done(function(d) {
                $('#workerRoleName').combobox({
                    data: d, 
                    valueField: 'name', 
                    textField: 'displayName'
                });
            });

            abp.services.app.field.getComboItems('Depot').done(function(depots) {
                crud.setComboBox('#depotId', depots);
                crud.setComboBox('#loanDepot', depots);
                
                var treeData = [];
                depots.forEach( function (val, index, arr) {
                    treeData.push({ id: val.value, text: val.displayText });
                });
                $('#tree').tree({
                    data: treeData,
                    onSelect: function (node) {
                        crud.parentId = node.id;
                        $('#datagrid').datagrid({
                            url: crud.dgDefault.name + '/GetPagedData/' + 'DepotId=' + node.id
                        });
                    }
                });
            });
      
            //crud.toolbarData.push({ text: "重置当前微信设备号", iconCls: "", handler: resetDevice });
            //crud.toolbarData.push({ text: "重置所有微信设备号", iconCls: "", handler: clearDevice });
        };

        crud.endfunction = function () {
            var title = abp.setting.get('VI.DepotTitleName');
            $('#cc').layout('panel', 'west').panel({title:title});

            // photo Preview processes
            $("#fm").form({
                onLoadSuccess: function (row) {
                    if (row && row.id > 0) {
                        $("#preview").attr("src", "Workers/GetPhoto/" + row.id);
                    }
                },
            });

            $("#dlg").dialog({
                onClose: function () {
                    var obj = document.getElementById('photoFile');
                    obj.outerHTML = obj.outerHTML;
                    $("#preview").attr("src", "");
                }
            });
        };
    </script>
}

@section headHtml
{
    <div id="cc" class="easyui-layout" data-options="fit:true">
        <div data-options="region:'west', split:true, minWidth:80, width:120">
            <ul id="tree" class="easyui-tree" style="margin-top:6px"></ul>
        </div>
        <div data-options="region:'center', border:false">
}
@section footHtml
{
        </div>
    </div>
}

@*弹窗*@
<div id="dlg" class="easyui-dialog" closed="true" modal="true" buttons="#dlg-buttons" align="center" style="width: 800px; padding: 10px;">
    <form id="fm" class="easyui-form" method="post" novalidate>
        <table class="edit-tbl2">
            <input id="id" name="id" type="hidden">
            <tr>
                <th><label for="depotId">所属:</label></th>
                <td><input id="depotId" name="depotId" class="easyui-combobox" style="width: 100%"></td>
            </tr>
            <tr>
                <th><label for="cn">编号：</label></th>
                <td><input name="cn" class="easyui-textbox" data-options="required:true, validType:'length[1, @Worker.MaxCnLength]'" style="width: 100%"></td>
                <th><Label for="name">姓名:</Label></th>
                <td><input name="name" class="easyui-textbox" data-options="required:true, validType:'length[1, @Worker.MaxNameLength]'" style="width: 100%"></td>
            </tr>
            <tr>
                <th><label for="postId">岗位:</label></th>
                <td><input id="post" name="postId" class="easyui-combobox" data-options="required:true" style="width: 100%"></td>
                <th><Label for="password">登录密码:</Label></th>
                <td><input name="password" class="easyui-numberbox" style="width: 100%"></td>
            </tr>
            <tr>
                <th><Label for="workerRoleName">登录角色名: </Label></th>
                <td><input name="workerRoleName" class="easyui-textbox" style="width: 100%"></td>
                <th><Label for="workRoles">可担任角色列表: </Label></th>
                <td><input name="workRoles" class="easyui-textbox" style="width: 100%"></td>
            </tr>
            <tr>
                <th><Label for="rfid">RFID:</Label></th>
                <td><input name="rfid" class="easyui-textbox" style="width: 100%"></td>
                <th><Label for="deviceId">微信设备号:</Label></th>
                <td><input name="deviceId" class="easyui-textbox" style="width: 100%"></td>
            </tr>
            <tr>
                <th><Label for="additiveInfo">附加认证信息:</Label></th>
                <td><input name="additiveInfo" class="easyui-numberbox" style="width: 100%"></td>
                <th><label for="isActive">启用：</label></th>
                <td><input name="isActive" class="easyui-switchbutton" data-options="height:24,onText:'是',offText:'否'"></td>
            </tr>
            <tr>
                <th><Label for="PhotoImage">照片:</Label></th>
                <td>
                    <img id="preview" alt="" src="" style="width:100px; height:110px;" />
                    <input id="photoFile" name="photoFile" type="file" onchange="$.setImagePreview('#preview', this)" />
                </td>
                <th><Label for="FingerImage">指纹图:</Label></th>
                <td>
                    <object classid="clsid:87772C8D-3C8C-4E55-A886-5BA5DA384424" id="ZAZFingerActivex"
                        name="ZAZFingerActivex" width="100" height="110" style="z-index:1">
                    </object>
                </td>
            </tr>
            <tr>
                <th><label for="finger">指纹一：</label></th>
                <td>
                    <input id="finger" name="finger" class="easyui-textbox" style="width: 100%" >
                    <a onclick="getFinger('finger')" class="easyui-linkbutton">获取指纹</a>
                    <a onclick="validFinger('finger')" class="easyui-linkbutton">验证指纹</a>
                </td>
                <th><label for="finger2">指纹二：</label></th>
                <td>
                    <input id="finger2" name="finger2" class="easyui-textbox" style="width: 100%" >
                    <a onclick="getFinger('finger2')" class="easyui-linkbutton">获取指纹</a>
                    <a onclick="validFinger('finger2')" class="easyui-linkbutton">验证指纹</a>
                </td>
            </tr>
        </table>
    </form>
</div>
